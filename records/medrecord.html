<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Medical Records | HealthConnect</title>
  <link href="https://fonts.googleapis.com/css2?family=Segoe+UI&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="medrecord.css">
  <!-- jsPDF Library -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
</head>
<body>
  <header class="header">
    <h1>üìã Medical Records</h1>
  </header>

  <main class="container">
    <div id="recordsContainer" class="grid"></div>
  </main>

<script>
async function loadMedicalRecords() {
  try {
    const response = await fetch("http://localhost:5000/appointments");

    if (!response.ok) {
      throw new Error(`Server error: ${response.status}`);
    }

    const records = await response.json();
    const recordsContainer = document.getElementById("recordsContainer");
    recordsContainer.innerHTML = "";

    if (!records || records.length === 0) {
      recordsContainer.innerHTML = "<p>No medical records found.</p>";
      return;
    }

    records.forEach((record) => {
      const card = document.createElement("div");
      card.classList.add("record-card");

      let doctorName = "";
      let clinicName = "";
      let specialization = "";

      if (typeof record.doctor === "object") {
        doctorName = record.doctor.name ? record.doctor.name.toUpperCase() : "";
        clinicName = record.doctor.clinic || "";
        specialization = record.doctor.specialization || "";
      } else {
        doctorName = record.doctor ? record.doctor.toUpperCase() : "";
        clinicName = record.clinic || "";
        specialization = record.specialization || "";
      }

      const doctorLine = `${doctorName} (${specialization}) ‚Äì ${clinicName}`;

      card.innerHTML = `
        <h3>üë®‚Äç‚öïÔ∏è ${doctorLine}</h3>
        <p><strong>Patient:</strong> ${record.patientName}</p>
        <p><strong>Age:</strong> ${record.age}</p>
        <p><strong>Blood Group:</strong> ${record.bloodGroup}</p>
        <p><strong>Issue:</strong> ${record.issue}</p>
        <p class="appointment-date"><strong>Appointment Date:</strong> ${record.appointmentDate || "Not provided"}</p>
        <p class="booking-time"><strong>Booking Time:</strong> ${record.bookingTime || record.date}</p>
        <button class="download-btn">‚¨á Download PDF</button>
        <button class="cancel-btn">‚ùå Cancel Appointment</button>
      `;

      // PDF Download Handler
      card.querySelector(".download-btn").addEventListener("click", () => {
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF();
        const pageWidth = doc.internal.pageSize.getWidth();

              // Cancel Appointment Handler
      card.querySelector(".cancel-btn").addEventListener("click", async () => {
        if (!confirm("Are you sure you want to cancel this appointment?")) return;

        try {
          const response = await fetch(`http://localhost:5000/appointments/${record.id}`, {
            method: "DELETE",
          });

          if (!response.ok) {
            throw new Error(`Failed to cancel appointment: ${response.status}`);
          }

          alert("‚úÖ Appointment cancelled successfully.");
          card.remove(); // remove the card from UI
        } catch (error) {
          console.error("Cancel error:", error);
          alert("‚ö†Ô∏è Failed to cancel appointment. Try again.");
        }
      });


        // Title
        doc.setFont("times", "bold");
        doc.setFontSize(22);
        doc.setTextColor(0, 51, 153);
        doc.text("Doctor Appointment Record", pageWidth / 2, 40, { align: "center" });

        // Horizontal line
        doc.setDrawColor(0, 51, 153);
        doc.setLineWidth(0.7);
        doc.line(30, 45, pageWidth - 30, 45);

        // Details
        doc.setFontSize(14);
        doc.setTextColor(0, 0, 0);
        doc.setFont("times", "normal");

        const details = [
          ["Doctor", doctorLine],
          ["Patient", record.patientName],
          ["Age", record.age],
          ["Blood Group", record.bloodGroup],
          ["Issue", record.issue],
          ["Appointment Date", record.appointmentDate || "Not provided"],
          ["Booking Time", record.bookingTime || record.date],
        ];

        let startY = 60;
        const labelX = 35;
        const valueX = 80;
        const rowHeight = 12;

        details.forEach(([label, value], i) => {
          doc.setFont("times", "bold");
          doc.text(`${label}:`, labelX, startY + i * rowHeight);
          doc.setFont("times", "normal");
          doc.text(String(value), valueX, startY + i * rowHeight);
        });

        // Footer
        doc.setFontSize(10);
        doc.setTextColor(100);
        doc.text(
          `Generated on: ${new Date().toLocaleString()}`,
          pageWidth - 35,
          doc.internal.pageSize.getHeight() - 15,
          { align: "right" }
        );

        doc.save(`${record.patientName}_appointment.pdf`);
      });

      // Cancel Appointment Handler
      card.querySelector(".cancel-btn").addEventListener("click", async () => {
        if (!confirm("Are you sure you want to cancel this appointment?")) return;

        try {
          const response = await fetch(`http://localhost:5000/appointments/${record.id}`, {
            method: "DELETE",
          });

          if (!response.ok) {
            throw new Error(`Failed to cancel appointment: ${response.status}`);
          }

          alert("‚úÖ Appointment cancelled successfully.");
          card.remove();
        } catch (error) {
          console.error("Cancel error:", error);
          alert("‚ö†Ô∏è Failed to cancel appointment. Try again.");
        }
      });

      recordsContainer.appendChild(card);
    });

  } catch (error) {
    console.error("Error loading records:", error);
    document.getElementById("recordsContainer").innerHTML =
      "<p>‚ö†Ô∏è Failed to load records. Please try again later.</p>";
  }
}

document.addEventListener("DOMContentLoaded", loadMedicalRecords);
</script>

</body>
</html>
